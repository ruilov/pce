<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PCE Inflation Explorer - Methodology</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-0: #0a0f1a;
      --bg-1: #111827;
      --bg-2: #172235;
      --border: #2a3a54;
      --text-1: #d8e3f3;
      --text-2: #a5b3c8;
      --text-3: #7e8da6;
      --accent: #5ea1ff;
      --radius: 10px;
      --mono: "JetBrains Mono", "Consolas", "Menlo", monospace;
      --sans: "Inter", system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text-1);
      background:
        radial-gradient(1000px 500px at -8% -12%, rgba(85, 144, 255, 0.22), transparent 58%),
        linear-gradient(160deg, #070b13 0%, var(--bg-0) 52%, #0d1524 100%);
      min-height: 100vh;
      line-height: 1.5;
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px 18px 28px;
    }
    .top {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(24, 37, 57, 0.96), rgba(17, 26, 41, 0.94));
      padding: 14px 16px;
      margin-bottom: 12px;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 22px;
      letter-spacing: 0.2px;
      color: #eef5ff;
    }
    .scope {
      margin: 0;
      color: var(--text-2);
      font-size: 13px;
    }
    .back-link {
      display: inline-block;
      margin-top: 10px;
      color: var(--text-2);
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12px;
    }
    .back-link:hover,
    .back-link:focus-visible {
      color: var(--text-1);
      text-decoration: underline;
    }
    section {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(24, 36, 56, 0.9), rgba(16, 25, 40, 0.92));
      padding: 14px 16px;
      margin-bottom: 10px;
    }
    h2 {
      margin: 0 0 8px;
      font-size: 15px;
      color: #eef5ff;
      letter-spacing: 0.15px;
    }
    p {
      margin: 0 0 8px;
      color: var(--text-2);
      font-size: 13px;
    }
    ul, ol {
      margin: 0;
      padding-left: 18px;
      color: var(--text-2);
      font-size: 13px;
    }
    li { margin: 0 0 5px; }
    .formula {
      margin: 7px 0;
      padding: 7px 9px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #142238;
      color: #dbe9ff;
      font-family: var(--mono);
      font-size: 12px;
      overflow-x: auto;
      white-space: nowrap;
    }
    .small-note {
      color: var(--text-3);
      font-size: 12px;
    }
    .note-box {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(20, 35, 56, 0.65);
      padding: 8px 10px;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      color: var(--text-2);
      margin-top: 8px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 6px 8px;
      vertical-align: top;
    }
    th {
      color: var(--text-1);
      text-align: left;
      background: #1b314f;
      font-weight: 600;
    }
    code {
      background: #1b2b42;
      border: 1px solid var(--border);
      color: #d8e8ff;
      padding: 2px 5px;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 11px;
    }
    a {
      color: var(--text-2);
      text-decoration: none;
    }
    a:hover,
    a:focus-visible {
      color: var(--text-1);
      text-decoration: underline;
    }
    .footer-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-3);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Methodology</h1>
      <p class="scope">This page explains how the explorer computes and decomposes inflation. It is designed so a technically trained user can reproduce the numbers from the source data.</p>
      <a class="back-link" href="index.htm">Back to Explorer</a>
    </div>

    <section>
      <h2>1) Data Inputs and Scope</h2>
      <ul>
        <li>Price index data: BEA NIPA Underlying Detail Table 2.4.4U.</li>
        <li>Nominal expenditure data: BEA NIPA Underlying Detail Table 2.4.5U.</li>
        <li>A hierarchy maps each component to a parent line for decomposition.</li>
      </ul>
      <p class="small-note">This page documents the methodology used in the explorer. It does not claim to reproduce every internal BEA production detail.</p>
    </section>

    <section>
      <h2>2) Notation and Units</h2>
      <table>
        <thead>
          <tr><th>Symbol</th><th>Meaning</th></tr>
        </thead>
        <tbody>
          <tr><td><code>P(i,t)</code></td><td>Price index level for component <code>i</code> at month <code>t</code>.</td></tr>
          <tr><td><code>N(i,t)</code></td><td>Nominal level for component <code>i</code> at month <code>t</code>.</td></tr>
          <tr><td><code>r(i,t)</code></td><td>Monthly simple rate: <code>P(i,t)/P(i,t-1)-1</code>.</td></tr>
          <tr><td><code>U</code></td><td>Selected child universe under a parent for decomposition.</td></tr>
          <tr><td><code>S</code></td><td>A coalition subset of <code>U</code> used in Shapley evaluation.</td></tr>
          <tr><td><code>v(S)</code></td><td>Annualized coalition value used as the Shapley characteristic function.</td></tr>
          <tr><td><code>phi_i</code></td><td>Shapley contribution of child <code>i</code>.</td></tr>
        </tbody>
      </table>
      <div class="note-box small-note">
        All displayed Contribution and Weight outputs are in percent units. Contribution values are annualized and displayed to 2 decimals.
      </div>
    </section>

    <section>
      <h2>3) Grouping and Buckets</h2>
      <ul>
        <li><code>Month</code>: each month is its own bucket.</li>
        <li><code>Quarter</code>: selected months are grouped by calendar quarter label <code>YYYY-Qx</code>.</li>
        <li><code>Year</code>: selected months are grouped by calendar year <code>YYYY</code>.</li>
        <li><code>Entire period</code>: one bucket from selected start month to end month.</li>
        <li><code>Compare</code>: Bucket A uses main start/end. Bucket B uses the compare controls.</li>
      </ul>
      <p class="small-note">Quarter and year buckets use only months inside the selected date range. Partial quarters/years are allowed.</p>
    </section>

    <section>
      <h2>4) Rate Construction and Annualization</h2>
      <p>Monthly component rate:</p>
      <div class="formula">r(i,t) = P(i,t) / P(i,t-1) - 1</div>
      <p>For a bucket with months <code>t=1..n</code>, chain the monthly gross rates:</p>
      <div class="formula">G = product_t (1 + r_t) - 1</div>
      <p>Annualize:</p>
      <div class="formula">A = 100 * ((1 + G)^(12/n) - 1)</div>
      <p>Fallback when compounding is invalid for a bucket:</p>
      <div class="formula">A_fallback = bucket_percent * (12/n)</div>
    </section>

    <section>
      <h2>5) Exact Contribution Decomposition (Fisher + Shapley)</h2>
      <p>For each parent, decomposition is run over its selected children. The characteristic function is evaluated on a fixed parent baseline.</p>
      <p>For coalition <code>S</code> and month <code>t</code>:</p>
      <div class="formula">g_i(S,t) = 1 + r(i,t) if i in S, else 1</div>
      <p>Let <code>s_i</code> be +1 normally and -1 for "Less:" lines. Define signed nominals <code>N*(i,t) = s_i * N(i,t)</code>.</p>
      <div class="formula">L_t(S) = sum_{i in U} [N*(i,t-1) * g_i(S,t)] / sum_{i in U} N*(i,t-1)</div>
      <div class="formula">P_t(S) = sum_{i in U} N*(i,t) / sum_{i in U} [N*(i,t) / g_i(S,t)]</div>
      <div class="formula">F_t(S) = sqrt(L_t(S) * P_t(S))</div>
      <p>Bucket coalition value:</p>
      <div class="formula">v(S) = annualize(100 * (product_t F_t(S) - 1), n)</div>
      <p>Shapley for each child <code>i</code> in a parent with <code>m</code> children:</p>
      <div class="formula">phi_i = sum_{S subset of U\{i}} [ |S|! * (m-|S|-1)! / m! ] * [v(S union {i}) - v(S)]</div>
      <p>For deeper descendants, the explorer computes local Shapley within each decomposed parent and projects those local contributions to the active-parent basis.</p>
      <div class="note-box small-note">
        Important detail: non-members of coalition <code>S</code> are frozen at zero change (<code>g=1</code>), not removed. This keeps decomposition aligned with parent inflation.
      </div>
    </section>

    <section>
      <h2>6) Replication Recipe (Single Bucket)</h2>
      <ol>
        <li>Select active parent and bucket months.</li>
        <li>Determine selected children set <code>U</code> after applying Exclude checkboxes.</li>
        <li>For each child and month, compute <code>r(i,t)</code> from price indexes.</li>
        <li>For every coalition <code>S</code> of <code>U</code>, compute <code>v(S)</code> using Fisher chaining and annualization.</li>
        <li>Compute Shapley <code>phi_i</code> for each child from coalition values.</li>
        <li>If line is deeper than one level below active parent, apply projection to active-parent basis.</li>
        <li>Compute residual: <code>Residual = Parent - sum(Children)</code> in the same bucket value space.</li>
      </ol>
      <p>Two-child shortcut (<code>U={A,B}</code>):</p>
      <div class="formula">phi_A = 0.5 * (v({A}) - v({})) + 0.5 * (v({A,B}) - v({B}))</div>
      <div class="formula">phi_B = 0.5 * (v({B}) - v({})) + 0.5 * (v({A,B}) - v({A}))</div>
      <div class="formula">with v({}) = 0 (after annualization)</div>
    </section>

    <section>
      <h2>7) Core Mode Rules</h2>
      <ul>
        <li>Comparator-backed official top lines are used for: <code>PCE (DPCCRG)</code>, <code>Goods (LA000062/IA000062)</code>, and <code>Services (LA000063/IA000063)</code>.</li>
        <li>When no user exclusions are active under the active parent, these official comparator paths anchor the top-line contribution.</li>
        <li>When exclusions are active, the top line is rebuilt dynamically from the selected universe.</li>
        <li>Any gap between top line and selected child sum is allocated to residual.</li>
      </ul>
    </section>

    <section>
      <h2>8) Exclude Semantics and Residual Visibility</h2>
      <ul>
        <li>Checkbox semantics are inverted: checked means excluded.</li>
        <li>For contribution, exclusion removes a line/subtree from the calculation universe.</li>
        <li>Tri-state parent checkbox reflects child states (checked, unchecked, mixed).</li>
        <li>Residual has its own exclude checkbox and is checked by default (excluded from chart by default).</li>
      </ul>
    </section>

    <section>
      <h2>9) Precision and Rounding Policy</h2>
      <ul>
        <li>Calculations use floating-point arithmetic.</li>
        <li>Near-zero residual values are clamped using a small tolerance before display.</li>
        <li>Displayed values are rounded to 2 decimals, so displayed sums can differ by 0.01 from unrounded internals.</li>
      </ul>
    </section>

    <section>
      <h2>10) Practical Limits</h2>
      <ul>
        <li>This is a transparent, reproducible methodology for the app, not an official BEA system specification.</li>
        <li>Fallback rules are used when bucket compounding or data availability make exact calculations unstable.</li>
      </ul>
    </section>

    <p class="footer-note">
      Source data: <a href="https://apps.bea.gov/iTable/?reqid=19&step=2&isuri=1&categories=underlying" target="_blank" rel="noopener noreferrer">BEA NIPA Underlying Detail Tables 2.4.4U and 2.4.5U</a>.
    </p>
  </div>
</body>
</html>
